var d=Object.defineProperty;var l=(o,e,t)=>e in o?d(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var s=(o,e,t)=>(l(o,typeof e!="symbol"?e+"":e,t),t);const a={id:1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,responseHeaders:[{header:"content-disposition",operation:chrome.declarativeNetRequest.HeaderOperation.REMOVE},{header:"content-disposition",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:"inline"}]},condition:{urlFilter:"*",resourceTypes:["main_frame","sub_frame"]}},u=[/google-analytics\.com/,/analytics\.google\.com/,/gtag/,/googletagmanager\.com/,/googleadservices\.com/,/googlesyndication\.com/,/clarity\.ms/,/firebaseio\.com/,/firebase.*\.com/,/sentry.*\.com/,/sentry-cdn\.com/,/hotjar\.com/,/doubleclick\.net/,/facebook\.com\/tr/,/linkedin\.com\/px/,/twitter\.com\/i\/jot/,/amplitude\.com/,/mixpanel\.com/,/segment\.com/,/segment\.io/];class h{constructor(){s(this,"activeRequests");s(this,"lastDomChange");s(this,"contentOnloadComplete");s(this,"thirdPartyScripts");this.reset()}reset(){this.activeRequests=new Map,this.lastDomChange=0,this.contentOnloadComplete=!1,this.thirdPartyScripts=new Set}isJavaScriptRequest(e){var t;return!!(e.type==="script"||(t=e.url.split("?")[0])!=null&&t.endsWith(".js"))}shouldTrackRequest(e){if(["image","font","media"].includes(e.type))return!1;if(this.isTrackingUrl(e.url))return console.log("is tracking url:",e.url),!1;if(this.contentOnloadComplete){if(this.isJavaScriptRequest(e))return console.log("is js:",e.url),this.thirdPartyScripts.add(e.url),!1;if(e.initiator){if(this.thirdPartyScripts.has(e.initiator))return!1;try{const r=new URL(e.initiator).hostname,i=new URL(e.url).hostname;if(r!==i)return!1}catch{return!0}}}return!0}isLoading(){const t=Date.now()-this.lastDomChange>1e3;if(!this.contentOnloadComplete)return console.log("content onload not complete"),!0;const r=this.activeRequests.size===0;return r||(console.log("has active requests:"),this.activeRequests.forEach(i=>{console.log("active request",i.url)})),!(t&&r)}contentOnloadFired(){this.contentOnloadComplete=!0}isTrackingUrl(e){return u.some(t=>t.test(e))}addRequest(e){this.shouldTrackRequest(e)&&this.activeRequests.set(e.requestId,e)}removeRequest(e){this.activeRequests.delete(e.requestId)}updateDomChange(e){this.lastDomChange=e}}class m{constructor(){s(this,"tabDetectors",new Map);this.init().catch(e=>{console.error("init error",e)})}async init(){await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[a.id],addRules:[a]});const e="reader-article-finder";(await chrome.scripting.getRegisteredContentScripts({ids:[e]})).length===0&&await chrome.scripting.registerContentScripts([{id:e,js:["assets/ReaderArticleFinder.js"],matches:["<all_urls>"],runAt:"document_start"}]),this.initLoadingDetector()}initLoadingDetector(){chrome.webNavigation.onBeforeNavigate.addListener(e=>{e.frameId===0&&this.getDetector(e.tabId).reset()}),chrome.webNavigation.onCompleted.addListener(e=>{e.frameId===0&&this.getDetector(e.tabId).contentOnloadFired()}),chrome.webRequest.onBeforeRequest.addListener(e=>{e.tabId>0&&this.getDetector(e.tabId).addRequest(e)},{urls:["<all_urls>"]},["requestBody"]),chrome.webRequest.onCompleted.addListener(e=>{e.tabId>0&&this.getDetector(e.tabId).removeRequest(e)},{urls:["<all_urls>"]}),chrome.webRequest.onErrorOccurred.addListener(e=>{e.tabId>0&&this.getDetector(e.tabId).removeRequest(e)},{urls:["<all_urls>"]}),chrome.runtime.onMessage.addListener((e,t,r)=>{var n;if(!((n=t.tab)!=null&&n.id))return;const i=this.getDetector(t.tab.id);switch(e.type){case"CHECK_LOADING_STATE":r({isLoading:i.isLoading()});break;case"DOM_CHANGED":e.timestamp&&i.updateDomChange(e.timestamp);break;case"CONTENT_ONLOAD":console.log("content onload fired",t.tab.url),i.contentOnloadFired();break;default:const c=e.type;console.log("unknown message",c)}}),chrome.tabs.onRemoved.addListener(e=>{this.tabDetectors.delete(e)})}getDetector(e){return this.tabDetectors.has(e)||this.tabDetectors.set(e,new h),this.tabDetectors.get(e)}}new m;
